<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Verification Complete - Latest News</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f7f7f7;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 1200px;
        margin: 24px auto;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 24px #dedede;
        padding: 24px 24px 24px 24px;
      }
      h1 {
        text-align: center;
        color: #1a237e;
      }
      #status {
        font-size: 22px;
        margin-bottom: 20px;
        text-align: center;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4caf50;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .ad-block,
      .ad-banner {
        background: #e3e3e3;
        border-radius: 7px;
        margin: 20px auto;
        text-align: center;
        color: #606060;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 120px;
        font-size: 26px;
        width: 100%;
      }
      .ad-banner {
        min-height: 300px;
        font-size: 34px;
      }
      .ad-vertical {
        min-width: 160px;
        min-height: 600px;
        max-width: 300px;
        background: #eaeaea;
        margin: 0 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        border-radius: 7px;
      }
      .main-content {
        display: flex;
        flex-direction: row;
      }
      .side-ads {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .news-section {
        flex: 1;
        margin-top: 0;
        margin-bottom: 0;
        padding: 0 12px;
      }
      .news-title {
        font-size: 28px;
        color: #2b3a67;
        margin: 18px 0 18px 0;
      }
      .news-list {
        display: flex;
        flex-wrap: wrap;
        gap: 24px;
        justify-content: space-between;
      }
      .news-card {
        background: #f1f5fb;
        border-radius: 8px;
        box-shadow: 0 1px 8px #e0e0e0;
        width: 32%;
        min-width: 290px;
        max-width: 400px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        margin-bottom: 8px;
        transition: box-shadow 0.2s;
      }
      .news-card:hover {
        box-shadow: 0 4px 16px #cfd8dc;
      }
      .news-img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        background: #e2e2e2;
      }
      .news-content {
        padding: 14px 15px 10px 15px;
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }
      .news-headline {
        font-size: 19px;
        font-weight: bold;
        color: #172b4d;
        margin-bottom: 7px;
        text-decoration: none;
        line-height: 1.25em;
        display: block;
        word-break: break-word;
      }
      .news-source {
        font-size: 13px;
        color: #6b7c93;
        margin-top: auto;
        margin-bottom: 3px;
      }
      #timerText {
        text-align: center;
        font-size: 22px;
        color: #333;
        margin-bottom: 8px;
      }
      #swipeMsgTop {
        display: none;
        text-align: center;
        font-size: 20px;
        margin: 18px auto 0 auto;
        color: #1a237e;
        font-weight: 600;
      }
      #nextBox {
        display: none;
        width: 100%;
        padding-top: 30px;
        text-align: center;
        position: sticky;
        bottom: 0;
        background: linear-gradient(to top, #f7f7f7 90%, transparent);
      }
      #nextBtn {
        margin: 16px auto 0;
        padding: 18px 44px;
        font-size: 26px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 7px;
        cursor: pointer;
        display: inline-block;
      }
      @media (max-width: 1200px) {
        .main-content {
          flex-direction: column;
        }
        .side-ads {
          flex-direction: row;
          justify-content: center;
        }
      }
      @media (max-width: 900px) {
        .news-list {
          flex-direction: column;
          align-items: center;
        }
        .news-card {
          width: 98vw;
          max-width: 98vw;
          min-width: 0;
        }
        .ad-banner {
          font-size: 24px;
        }
      }
      @media (max-width: 600px) {
        .container {
          padding: 4px;
        }
        .news-card {
          width: 98vw;
          max-width: 98vw;
          min-width: 0;
        }
        .ad-block,
        .ad-banner,
        .ad-vertical {
          font-size: 16px;
          min-height: 60px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="ad-banner">Top Banner Ad (Google AdSense)</div>
      <h1 id="status">üîÑ Verifying...</h1>
      <div class="spinner" id="spinner"></div>
      <div class="ad-block">Ad Block (Google AdSense)</div>
      <p id="timerText" style="text-align: center">
        Please wait 15 seconds before you can go back to Telegram.
      </p>
      <div id="swipeMsgTop">Swipe below to return to Telegram üëá</div>
      <div class="main-content">
        <div class="side-ads">
          <div class="ad-vertical">Left Vertical Ad</div>
          <div class="ad-vertical">Left Vertical Ad</div>
        </div>
        <div class="news-section">
          <div class="news-title">Latest News</div>
          <div id="newsList" class="news-list"></div>
          <div class="ad-block">Ad Block (Google AdSense)</div>
        </div>
        <div class="side-ads">
          <div class="ad-vertical">Right Vertical Ad</div>
          <div class="ad-vertical">Right Vertical Ad</div>
        </div>
      </div>
      <div class="ad-banner">Bottom Banner Ad (Google AdSense)</div>
      <div id="nextBox">
        <button id="nextBtn" style="display: none">Go to Telegram ‚û°Ô∏è</button>
      </div>
    </div>
    <script>
      let userId = null;
      let verificationPassed = false;
      let timerPassed = false;
      let nextBtnVisible = false;
      function tryRedirect() {
        if (verificationPassed && timerPassed && nextBtnVisible) {
          window.location.href = "https://t.me/juice_01_bot?start=verified";
        }
      }
      function showNextBox() {
        document.getElementById("nextBox").style.display = "block";
        document.getElementById("swipeMsgTop").style.display = "block";
        document.getElementById("timerText").innerText =
          "‚úÖ Verification step finished!";
        timerPassed = true;
      }
      function startCountdown() {
        let seconds = 15;
        const countdown = setInterval(() => {
          if (seconds > 0) {
            document.getElementById(
              "timerText"
            ).innerText = `Please wait ${seconds} seconds before you can go back to Telegram.`;
            seconds--;
          } else {
            clearInterval(countdown);
            showNextBox();
          }
        }, 1000);
      }
      async function verifyUser() {
        const urlParams = new URLSearchParams(window.location.search);
        userId = urlParams.get("userId");
        if (!userId) userId = sessionStorage.getItem("userId");
        if (!userId) {
          document.getElementById("status").innerText = "‚ùå Missing user ID.";
          document.getElementById("spinner").style.display = "none";
          verificationPassed = true;
          return;
        }
        try {
          const response = await fetch(
            "http://localhost:3000/api/verify-user",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ userId }),
            }
          );
          if (response.ok) {
            document.getElementById("status").innerText = "‚úÖ Token Verified!";
            verificationPassed = true;
          } else {
            document.getElementById("status").innerText =
              "‚ùå Verification failed.";
            document.getElementById("spinner").style.display = "none";
          }
        } catch (err) {
          document.getElementById("status").innerText =
            "‚ùå Server error. Please try again.";
          document.getElementById("spinner").style.display = "none";
        }
      }
      window.addEventListener("scroll", function () {
        if (!(timerPassed && verificationPassed) || nextBtnVisible) return;
        let nextBox = document.getElementById("nextBox");
        let rect = nextBox.getBoundingClientRect();
        if (
          window.innerHeight + window.scrollY >=
            document.body.offsetHeight - 80 ||
          (rect.top < window.innerHeight && rect.bottom > 0)
        ) {
          document.getElementById("nextBtn").style.display = "inline-block";
          nextBtnVisible = true;
        }
      });
      window.onload = () => {
        startCountdown();
        verifyUser();
        document.getElementById("nextBtn").onclick = () => {
          tryRedirect();
        };
        fetchNews();
      };
      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("nextBox").style.display = "none";
        document.getElementById("swipeMsgTop").style.display = "none";
      });
      async function fetchNews() {
        try {
          const resp = await fetch(
            "https://tg-backend-psi.vercel.app/api/get-news"
          );
          const data = await resp.json();
          // Now use data.articles as before
          const newsList = document.getElementById("newsList");
          newsList.innerHTML = "";
          (data.articles || []).forEach((article) => {
            const card = document.createElement("div");
            card.className = "news-card";
            card.innerHTML = `
        <img class="news-img" src="${
          article.urlToImage ||
          "https://via.placeholder.com/215x112?text=No+Image"
        }" alt="news image"/>
        <div class="news-content">
          <a href="${article.url}" target="_blank" class="news-headline">${
              article.title
            }</a>
          <div class="news-source">${
            article.source && article.source.name ? article.source.name : ""
          }</div>
        </div>
      `;
            newsList.appendChild(card);
          });
        } catch (e) {
          document.getElementById("newsList").innerHTML =
            "<div style='color:#a00;margin:18px auto;'>Unable to load news.</div>";
        }
      }
    </script>
  </body>
</html>
